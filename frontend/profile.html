<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile ‚Äî MusicApp</title>
  <link rel="stylesheet" href="shared.css" />
  <style>
    .profile-hero {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 40px;
      display: flex;
      align-items: center;
      gap: 32px;
      margin-bottom: 40px;
      background: linear-gradient(135deg, rgba(124,58,237,0.08) 0%, rgba(14,14,22,1) 100%);
    }
    .avatar {
      width: 90px; height: 90px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--pink));
      display: flex; align-items: center; justify-content: center;
      font-family: var(--font-display);
      font-size: 36px;
      font-weight: 800;
      flex-shrink: 0;
      box-shadow: 0 8px 30px rgba(124,58,237,0.35);
    }
    .profile-name {
      font-family: var(--font-display);
      font-size: 32px; font-weight: 800; margin-bottom: 6px;
    }
    .profile-email { color: var(--muted); font-size: 15px; margin-bottom: 16px; }
    .profile-meta { display: flex; gap: 24px; }
    .stat { text-align: center; }
    .stat-num { font-family: var(--font-display); font-size: 28px; font-weight: 800; color: var(--accent); }
    .stat-lbl { color: var(--muted); font-size: 13px; }

    .section-title { font-family: var(--font-display); font-size: 22px; font-weight: 700; margin-bottom: 20px; }

    .song-row {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 18px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 10px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .song-row:hover { border-color: rgba(124,58,237,0.5); }

    .song-thumb {
      width: 48px; height: 48px;
      border-radius: 8px;
      background: var(--surface);
      flex-shrink: 0;
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px;
    }
    .song-thumb img { width: 100%; height: 100%; object-fit: cover; }

    .song-info { flex: 1; min-width: 0; }
    .song-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .song-meta  { color: var(--muted); font-size: 13px; }

    .genre-tag {
      padding: 3px 12px;
      background: rgba(124,58,237,0.12);
      color: var(--accent);
      border-radius: 50px;
      font-size: 12px;
      white-space: nowrap;
    }

    .danger-zone {
      margin-top: 48px;
      padding: 24px;
      border: 1px solid rgba(239,68,68,0.2);
      border-radius: var(--radius);
      background: rgba(239,68,68,0.03);
    }
    .danger-title { color: var(--danger); font-weight: 600; margin-bottom: 8px; }
    .danger-desc  { color: var(--muted); font-size: 14px; margin-bottom: 16px; }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  </style>
</head>
<body>

<nav class="navbar">
  <a class="logo" href="play.html">üéµ Music<span>App</span></a>
  <div class="nav-links">
    <a href="play.html">üéß Play</a>
    <a href="upload.html">‚¨ÜÔ∏è Upload</a>
    <a href="profile.html" class="active">üë§ Profile</a>
  </div>
  <button class="btn-logout" onclick="logout()">Sign Out</button>
</nav>

<div class="page-container">

  <!-- Profile Hero -->
  <div class="profile-hero" id="profileHero">
    <div style="color:var(--muted);">Loading profile...</div>
  </div>

  <!-- My Songs -->
  <div class="section-title">My Uploads</div>
  <div id="mySongsList"></div>

  <!-- Danger Zone -->
  <div class="danger-zone">
    <div class="danger-title">‚ö†Ô∏è Sign Out</div>
    <div class="danger-desc">This will sign you out of your account on this device.</div>
    <button class="btn btn-danger" onclick="logout()" style="font-size:14px;padding:10px 24px;">Sign Out</button>
  </div>
</div>

<audio id="audioEl" style="display:none;"></audio>

<script src="config.js"></script>
<script>
  requireAuth();

  function escHtml(s) {
    return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function formatBytes(b) {
    if (!b) return '‚Äî';
    if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
    return (b/(1024*1024)).toFixed(1) + ' MB';
  }
  function formatDate(iso) {
    if (!iso) return '';
    return new Date(iso).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
  }

  async function loadProfile() {
    try {
      const { user } = await api.get('/auth/me');
      const initials = user.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
      document.getElementById('profileHero').innerHTML = `
        <div class="avatar">${initials}</div>
        <div>
          <div class="profile-name">${escHtml(user.name)}</div>
          <div class="profile-email">${escHtml(user.email)}</div>
          <div class="profile-meta">
            <div class="stat">
              <div class="stat-num" id="songCount">‚Äî</div>
              <div class="stat-lbl">Songs</div>
            </div>
            <div class="stat">
              <div class="stat-num">${formatDate(user.created_at).split(' ')[0]}</div>
              <div class="stat-lbl">Member since ${formatDate(user.created_at)}</div>
            </div>
          </div>
        </div>
      `;
    } catch (e) {
      document.getElementById('profileHero').innerHTML = '<div style="color:var(--danger);">Failed to load profile.</div>';
    }
  }

  const audio = document.getElementById('audioEl');
  let currentPlaying = null;

  function playSong(song) {
    if (currentPlaying === song.id && !audio.paused) {
      audio.pause();
      currentPlaying = null;
      return;
    }
    audio.src = song.audio_url;
    audio.play();
    currentPlaying = song.id;
  }

  async function loadMySongs() {
    const container = document.getElementById('mySongsList');
    container.innerHTML = '<div style="color:var(--muted);padding:20px;">Loading...</div>';
    try {
      const data = await api.get('/songs/my');
      document.getElementById('songCount').textContent = data.songs.length;

      if (!data.songs.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size:48px;margin-bottom:16px;">üéµ</div>
            <div>You haven't uploaded any songs yet.</div>
            <a href="upload.html" class="btn btn-primary" style="display:inline-flex;margin-top:20px;width:auto;">Upload Now</a>
          </div>`;
        return;
      }

      container.innerHTML = data.songs.map(s => `
        <div class="song-row" onclick="playSong(${JSON.stringify(s).replace(/"/g,'&quot;')})">
          <div class="song-thumb">
            ${s.cover_url ? `<img src="${escHtml(s.cover_url)}" alt="" />` : 'üéµ'}
          </div>
          <div class="song-info">
            <div class="song-title">${escHtml(s.title)}</div>
            <div class="song-meta">${escHtml(s.artist)}${s.album ? ' ¬∑ ' + escHtml(s.album) : ''} ¬∑ ${formatDate(s.uploaded_at)}</div>
          </div>
          ${s.genre ? `<span class="genre-tag">${escHtml(s.genre)}</span>` : ''}
          <div style="color:var(--muted);font-size:12px;min-width:65px;text-align:right;">${formatBytes(s.file_size)}</div>
          <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteSong(${s.id})">üóë</button>
        </div>
      `).join('');
    } catch (e) {
      container.innerHTML = '<div style="color:var(--danger);">Failed to load songs.</div>';
    }
  }

  async function deleteSong(id) {
    if (!confirm('Delete this song permanently?')) return;
    try {
      await api.del(`/songs/${id}`);
      loadMySongs();
    } catch (e) {
      alert(e.error || 'Failed to delete.');
    }
  }

  // Make playSong work with onclick (song object from data attribute)
  window.playSong = function(song) {
    if (typeof song === 'object') {
      audio.src = song.audio_url;
      audio.play();
    }
  };

  loadProfile();
  loadMySongs();
</script>
</body>
</html>