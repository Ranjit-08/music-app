<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile ‚Äî ListenMe</title>
  <link rel="stylesheet" href="shared.css" />
  <style>
    .profile-hero {
      background: linear-gradient(135deg, rgba(124,58,237,0.12), rgba(14,14,22,0.98));
      border: 1px solid var(--border); border-radius: 20px;
      padding: 40px; display: flex; align-items: center; gap: 32px;
      margin-bottom: 40px; overflow: hidden; position: relative;
      animation: fadeInUp 0.5s ease both;
    }
    .profile-hero::before {
      content:''; position:absolute; top:-40px; right:-40px;
      width:200px; height:200px; border-radius:50%;
      background:radial-gradient(circle,rgba(124,58,237,0.15),transparent);
      pointer-events:none;
    }
    .avatar {
      width: 88px; height: 88px; border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--pink));
      display: flex; align-items: center; justify-content: center;
      font-family: var(--font-display); font-size: 34px; font-weight: 900;
      color: #fff; flex-shrink: 0;
      box-shadow: 0 8px 32px rgba(124,58,237,0.4);
      animation: avatarPop 0.6s cubic-bezier(0.16,1,0.3,1) both;
    }
    @keyframes avatarPop {
      from { transform: scale(0.6) rotate(-10deg); opacity: 0; }
      to   { transform: scale(1)   rotate(0deg);   opacity: 1; }
    }
    .profile-name { font-family: var(--font-display); font-size: 30px; font-weight: 800; margin-bottom: 4px; }
    .profile-email { color: var(--text-2); font-size: 14px; margin-bottom: 18px; }
    .profile-stats { display: flex; gap: 28px; flex-wrap: wrap; }
    .stat { text-align: center; }
    .stat-num { font-family: var(--font-display); font-size: 26px; font-weight: 800; color: var(--accent); }
    .stat-lbl { color: var(--muted); font-size: 12px; margin-top: 2px; }

    .section-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .section-title { font-family: var(--font-display); font-size: 22px; font-weight: 800; }

    .tabs { display: flex; gap: 6px; margin-bottom: 24px; }
    .tab {
      padding: 8px 20px; border-radius: 50px; border: 1px solid var(--border);
      background: var(--card); color: var(--muted); font-size: 14px;
      font-weight: 500; cursor: pointer; transition: all 0.2s;
      font-family: var(--font-body);
    }
    .tab:hover { border-color: var(--border-hover); color: var(--text); }
    .tab.active { background: rgba(124,58,237,0.12); border-color: var(--primary); color: var(--accent); }

    .song-row {
      display: flex; align-items: center; gap: 14px; padding: 12px 16px;
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius-sm); margin-bottom: 8px; cursor: pointer;
      transition: all 0.2s; animation: fadeInUp 0.3s ease both;
    }
    .song-row:hover { border-color: rgba(124,58,237,0.4); transform: translateX(3px); }

    .song-thumb {
      width: 46px; height: 46px; border-radius: 8px; background: var(--surface);
      flex-shrink: 0; overflow: hidden;
      display: flex; align-items: center; justify-content: center; font-size: 20px;
    }
    .song-thumb img { width:100%; height:100%; object-fit:cover; }
    .song-info { flex: 1; min-width: 0; }
    .song-title { font-weight: 700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .song-meta  { color: var(--text-2); font-size: 13px; }
    .genre-tag {
      padding: 3px 12px; border-radius: 50px;
      background: rgba(124,58,237,0.1); color: var(--accent);
      font-size: 11px; font-weight: 600; white-space: nowrap; flex-shrink: 0;
    }

    .danger-zone {
      margin-top: 48px; padding: 24px;
      border: 1px solid rgba(239,68,68,0.2); border-radius: var(--radius);
      background: rgba(239,68,68,0.03);
    }
    .danger-title { color: var(--danger); font-weight: 700; margin-bottom: 6px; }
    .danger-desc  { color: var(--muted); font-size: 14px; margin-bottom: 16px; }

    .empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
    .empty-state .icon { font-size:48px; margin-bottom:14px; opacity:0.6; }
  </style>
</head>
<body>

<nav class="navbar">
  <a class="logo" href="play.html">
    <div class="logo-icon">üéß</div>Listen<span>Me</span>
  </a>
  <div class="nav-links" id="navLinks">
    <a href="play.html">Discover</a>
    <a href="profile.html" class="active">Profile</a>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <span id="adminBadge" class="admin-badge" style="display:none;">‚ö° Admin</span>
    <button class="btn-logout" onclick="logout()">Sign Out</button>
  </div>
</nav>

<div class="page-container">
  <!-- Hero -->
  <div class="profile-hero" id="profileHero">
    <div style="color:var(--muted);">Loading‚Ä¶</div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('favorites',this)">‚ù§Ô∏è Favorites</button>
    <button class="tab" onclick="switchTab('recent',this)">üïê Recent</button>
  </div>

  <div id="tabContent"></div>

  <!-- Danger zone -->
  <div class="danger-zone">
    <div class="danger-title">‚ö†Ô∏è Sign Out</div>
    <div class="danger-desc">Signs you out of your ListenMe account on this device.</div>
    <button class="btn btn-danger" onclick="logout()" style="font-size:14px;padding:10px 24px;">Sign Out</button>
  </div>
</div>

<audio id="audioEl" style="display:none;"></audio>

<script src="config.js"></script>
<script>
requireAuth();

const audio = document.getElementById('audioEl');
let favSongs    = [];
let recentSongs = [];
let currentTab  = 'favorites';

async function loadProfile() {
  try {
    const { user } = await api.get('/auth/me');
    const inits    = user.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);

    if (user.is_admin) {
      document.getElementById('adminBadge').style.display = 'inline-flex';
      const navLinks = document.getElementById('navLinks');
      const uploadLink = document.createElement('a');
      uploadLink.href = 'upload.html'; uploadLink.textContent = 'Upload';
      navLinks.insertBefore(uploadLink, navLinks.children[1]);
    }

    document.getElementById('profileHero').innerHTML = `
      <div class="avatar">${inits}</div>
      <div>
        <div class="profile-name">${esc(user.name)}</div>
        <div class="profile-email">${esc(user.email)}</div>
        ${user.is_admin ? '<div class="admin-badge" style="margin-bottom:14px;">‚ö° Admin</div>' : ''}
        <div class="profile-stats">
          <div class="stat">
            <div class="stat-num" id="favCount">‚Äî</div>
            <div class="stat-lbl">Favourites</div>
          </div>
          <div class="stat">
            <div class="stat-num">${formatDate(user.created_at)}</div>
            <div class="stat-lbl">Member since</div>
          </div>
        </div>
      </div>
    `;
  } catch(e) {
    document.getElementById('profileHero').innerHTML = '<div style="color:var(--danger);">Failed to load profile.</div>';
  }
}

async function loadFavorites() {
  try {
    const data = await api.get('/songs/favorites');
    favSongs   = data.songs;
    document.getElementById('favCount').textContent = favSongs.length;
    if (currentTab === 'favorites') renderSongs(favSongs, true);
  } catch(e) { /* silent */ }
}

async function loadRecent() {
  try {
    const data = await api.get('/songs');
    recentSongs = data.songs.slice(0, 20);
    if (currentTab === 'recent') renderSongs(recentSongs, false);
  } catch(e) { /* silent */ }
}

function switchTab(tab, el) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  if (tab === 'favorites') renderSongs(favSongs, true);
  else renderSongs(recentSongs, false);
}

function renderSongs(songs, showRemove) {
  const container = document.getElementById('tabContent');
  if (!songs.length) {
    const icon = showRemove ? '‚ù§Ô∏è' : 'üéµ';
    const msg  = showRemove ? "You haven't favourited any songs yet." : "No songs in library yet.";
    container.innerHTML = `<div class="empty-state"><div class="icon">${icon}</div><div>${msg}</div><a href="play.html" class="btn btn-primary" style="display:inline-flex;width:auto;margin-top:20px;">Go to Library</a></div>`;
    return;
  }
  container.innerHTML = songs.map((s, i) => `
    <div class="song-row" style="animation-delay:${i*0.04}s" onclick="playSong('${escJs(s.audio_url)}')">
      <div class="song-thumb">${s.cover_url ? `<img src="${esc(s.cover_url)}" />` : 'üéµ'}</div>
      <div class="song-info">
        <div class="song-title">${esc(s.title)}</div>
        <div class="song-meta">${esc(s.artist)}${s.album ? ' ¬∑ ' + esc(s.album) : ''}</div>
      </div>
      ${s.genre ? `<span class="genre-tag">${esc(s.genre)}</span>` : ''}
      ${showRemove
        ? `<button class="btn btn-danger btn-sm" onclick="event.stopPropagation();removeFav(${s.id})">‚ô° Remove</button>`
        : ''}
    </div>
  `).join('');
}

function playSong(url) {
  audio.src = url; audio.play();
}

async function removeFav(id) {
  try {
    await api.del(`/songs/${id}/favorite`);
    await loadFavorites();
  } catch(e) { alert(e.error || 'Failed to remove.'); }
}

function formatDate(iso) {
  if (!iso) return '‚Äî';
  return new Date(iso).toLocaleDateString('en-US', { year:'numeric', month:'short' });
}
function esc(s)   { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escJs(s) { return (s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

loadProfile();
loadFavorites();
loadRecent();
</script>
</body>
</html>