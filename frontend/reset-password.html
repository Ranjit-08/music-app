<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password ‚Äî ListenMe</title>
  <link rel="stylesheet" href="shared.css" />
  <style>
    .icon-wrap {
      width: 72px; height: 72px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 32px; margin: 0 auto 24px; position: relative;
      animation: iconPop 0.5s 0.2s cubic-bezier(0.16,1,0.3,1) both;
    }
    @keyframes iconPop {
      from { opacity:0; transform:scale(0.5); }
      to   { opacity:1; transform:scale(1);   }
    }
    .icon-primary { background:rgba(124,58,237,0.12); border:1px solid rgba(124,58,237,0.25); }
    .icon-success { background:rgba(34,197,94,0.12);  border:1px solid rgba(34,197,94,0.25);  }
    .icon-danger  { background:rgba(239,68,68,0.12);  border:1px solid rgba(239,68,68,0.25);  }

    .icon-wrap::after {
      content:''; position:absolute; inset:-6px; border-radius:50%;
      border:2px solid rgba(124,58,237,0.15);
      animation:pulseRing 2s ease-out infinite;
    }
    @keyframes pulseRing {
      0%   { transform:scale(1);   opacity:1; }
      100% { transform:scale(1.3); opacity:0; }
    }
    .icon-success::after { border-color: rgba(34,197,94,0.15); }
    .icon-danger::after  { border-color: rgba(239,68,68,0.15);  animation:none; }

    .center-title {
      font-family:var(--font-display);
      font-size:24px; font-weight:800;
      margin-bottom:8px; text-align:center;
    }
    .center-sub { color:var(--muted); font-size:14px; text-align:center; margin-bottom:28px; line-height:1.7; }

    .loading-text {
      text-align:center; padding:40px 0; color:var(--muted);
      animation: fadeInUp 0.4s ease both;
    }
    .dots { display:inline-flex; gap:5px; vertical-align:middle; }
    .dots span {
      width:6px; height:6px; border-radius:50%;
      background:var(--primary); display:inline-block;
      animation:dotBounce 1.2s ease-in-out infinite;
    }
    .dots span:nth-child(2) { animation-delay:0.2s; }
    .dots span:nth-child(3) { animation-delay:0.4s; }
    @keyframes dotBounce {
      0%,80%,100% { transform:scale(0.7); opacity:0.4; }
      40%          { transform:scale(1.2); opacity:1;   }
    }
  </style>
</head>
<body>
<div class="auth-wrapper">
  <div class="auth-card">

    <!-- Loading -->
    <div class="step active" id="stepLoading">
      <div class="loading-text">
        Verifying your link
        <div class="dots">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>

    <!-- Expired -->
    <div class="step" id="stepExpired">
      <div class="icon-wrap icon-danger">‚è∞</div>
      <div class="center-title">Link Expired</div>
      <p class="center-sub">
        This reset link is invalid or has expired.<br/>
        Reset links are only valid for <strong style="color:var(--text)">1 hour</strong>.
      </p>
      <a href="forgot-password.html" class="btn btn-primary" style="text-decoration:none;margin-bottom:12px;">
        Request New Link
      </a>
      <div class="link-row"><a href="login.html">Back to Login</a></div>
    </div>

    <!-- Reset Form -->
    <div class="step" id="stepForm">
      <div class="icon-wrap icon-primary">üîê</div>
      <div class="auth-logo" style="text-align:center;">New <span>Password</span></div>
      <p class="auth-subtitle" style="text-align:center;">Choose a strong password for your account.</p>

      <div class="alert alert-error" id="formErr"></div>

      <div class="form-group">
        <label>New Password</label>
        <div class="password-wrap">
          <input type="password" id="password" placeholder="Min. 6 characters"
                 oninput="checkStrength(this.value)" />
          <span class="toggle-pw" onclick="togglePw('password',this)">üëÅ</span>
        </div>
        <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
        <div class="strength-label" id="strengthLabel"></div>
      </div>

      <div class="form-group">
        <label>Confirm Password</label>
        <div class="password-wrap">
          <input type="password" id="confirmPassword" placeholder="Repeat your password" />
          <span class="toggle-pw" onclick="togglePw('confirmPassword',this)">üëÅ</span>
        </div>
      </div>

      <button class="btn btn-primary" id="resetBtn" onclick="doReset()">
        <span id="resetText">Set New Password</span>
        <div class="spinner" id="resetSpinner"></div>
      </button>
    </div>

    <!-- Success -->
    <div class="step" id="stepSuccess">
      <div class="icon-wrap icon-success">‚úÖ</div>
      <div class="center-title">Password Updated!</div>
      <p class="center-sub">
        Your password has been reset successfully.<br/>
        You can now sign in with your new password.
      </p>
      <a href="login.html" class="btn btn-primary" style="text-decoration:none;">
        Go to Login ‚Üí
      </a>
    </div>

  </div>
</div>
<script src="config.js"></script>
<script>
  if (localStorage.getItem('token')) window.location.href = 'play.html';

  const urlParams  = new URLSearchParams(window.location.search);
  const resetToken = urlParams.get('token');

  function showStep(id) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  async function verifyToken() {
    if (!resetToken) { showStep('stepExpired'); return; }
    try {
      const data = await api.post('/auth/verify-reset-token', { token: resetToken }, false);
      showStep(data.valid ? 'stepForm' : 'stepExpired');
    } catch (e) {
      showStep('stepExpired');
    }
  }

  function togglePw(id, icon) {
    const input = document.getElementById(id);
    input.type  = input.type === 'password' ? 'text' : 'password';
    icon.textContent = input.type === 'password' ? 'üëÅ' : 'üôà';
  }

  function checkStrength(pw) {
    const fill  = document.getElementById('strengthFill');
    const label = document.getElementById('strengthLabel');
    let score   = 0;
    if (pw.length >= 6)         score++;
    if (pw.length >= 10)        score++;
    if (/[A-Z]/.test(pw))       score++;
    if (/[0-9]/.test(pw))       score++;
    if (/[^A-Za-z0-9]/.test(pw)) score++;
    const levels = [
      { pct:'0%',   color:'',          label:'' },
      { pct:'25%',  color:'#ef4444',   label:'Weak' },
      { pct:'50%',  color:'#f97316',   label:'Fair' },
      { pct:'75%',  color:'#eab308',   label:'Good' },
      { pct:'90%',  color:'#22c55e',   label:'Strong' },
      { pct:'100%', color:'#16a34a',   label:'Very strong' },
    ];
    const lvl = levels[Math.min(score, 5)];
    fill.style.width      = lvl.pct;
    fill.style.background = lvl.color;
    label.textContent     = lvl.label;
    label.style.color     = lvl.color;
  }

  function setLoading(on) {
    document.getElementById('resetText').style.display    = on ? 'none' : 'inline';
    document.getElementById('resetSpinner').style.display = on ? 'block' : 'none';
    document.getElementById('resetBtn').disabled          = on;
  }

  async function doReset() {
    document.getElementById('formErr').style.display = 'none';
    const password = document.getElementById('password').value;
    const confirm  = document.getElementById('confirmPassword').value;

    const err = document.getElementById('formErr');
    const showErr = (msg) => { err.textContent = msg; err.style.display = 'block'; };

    if (!password)             return showErr('Please enter a new password.');
    if (password.length < 6)   return showErr('Password must be at least 6 characters.');
    if (password !== confirm)  return showErr('Passwords do not match.');

    setLoading(true);
    try {
      await api.post('/auth/reset-password', { token: resetToken, password }, false);
      showStep('stepSuccess');
    } catch (e) {
      showErr(e.error || 'Failed to reset password. Please try again.');
    } finally {
      setLoading(false);
    }
  }

  verifyToken();
</script>
</body>
</html>