<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password ‚Äî MusicApp</title>
  <link rel="stylesheet" href="shared.css" />
  <style>
    .step { display: none; }
    .step.active { display: block; }

    .success-icon { font-size: 56px; text-align: center; margin-bottom: 20px; }

    .password-wrap { position: relative; }
    .toggle-pw {
      position: absolute; right: 14px; top: 50%;
      transform: translateY(-50%);
      cursor: pointer; font-size: 18px; user-select: none;
      color: var(--muted);
    }
    .toggle-pw:hover { color: var(--text); }

    .strength-bar {
      height: 4px; border-radius: 4px;
      background: var(--border); margin-top: 8px;
      overflow: hidden;
    }
    .strength-fill {
      height: 100%; border-radius: 4px;
      width: 0%; transition: width 0.3s, background 0.3s;
    }
    .strength-label {
      font-size: 12px; color: var(--muted); margin-top: 4px;
    }

    .expired-box {
      text-align: center; padding: 20px 0;
    }
    .expired-icon { font-size: 56px; margin-bottom: 16px; }
    .expired-title {
      font-family: var(--font-display);
      font-size: 24px; font-weight: 800; margin-bottom: 8px;
    }
    .expired-sub { color: var(--muted); font-size: 14px; margin-bottom: 24px; }
  </style>
</head>
<body>
<div class="auth-wrapper">
  <div class="auth-card">

    <!-- Loading state -->
    <div class="step active" id="stepLoading">
      <div style="text-align:center;padding:40px 0;color:var(--muted);">
        Verifying your reset link...
      </div>
    </div>

    <!-- Expired/Invalid token -->
    <div class="step" id="stepExpired">
      <div class="expired-box">
        <div class="expired-icon">‚è∞</div>
        <div class="expired-title">Link Expired</div>
        <p class="expired-sub">
          This password reset link is invalid or has expired.<br />
          Reset links are valid for 1 hour only.
        </p>
        <a href="forgot-password.html" class="btn btn-primary" style="text-decoration:none;">
          Request New Link
        </a>
        <div class="link-row" style="margin-top:16px;">
          <a href="login.html">Back to Login</a>
        </div>
      </div>
    </div>

    <!-- Reset Form -->
    <div class="step" id="stepForm">
      <div class="auth-logo">üéµ Music<span>App</span></div>
      <p class="auth-subtitle">Choose a new password for your account.</p>

      <div class="alert alert-error" id="formErr"></div>

      <div class="form-group">
        <label>New Password</label>
        <div class="password-wrap">
          <input type="password" id="password" placeholder="Min. 6 characters"
                 oninput="checkStrength(this.value)" />
          <span class="toggle-pw" onclick="togglePw('password', this)">üëÅ</span>
        </div>
        <div class="strength-bar">
          <div class="strength-fill" id="strengthFill"></div>
        </div>
        <div class="strength-label" id="strengthLabel"></div>
      </div>

      <div class="form-group">
        <label>Confirm Password</label>
        <div class="password-wrap">
          <input type="password" id="confirmPassword" placeholder="Repeat your password" />
          <span class="toggle-pw" onclick="togglePw('confirmPassword', this)">üëÅ</span>
        </div>
      </div>

      <button class="btn btn-primary" id="resetBtn" onclick="doReset()">
        <span id="resetText">Set New Password</span>
        <div class="spinner" id="resetSpinner"></div>
      </button>
    </div>

    <!-- Success -->
    <div class="step" id="stepSuccess">
      <div class="success-icon">‚úÖ</div>
      <div style="font-family:var(--font-display);font-size:26px;font-weight:800;margin-bottom:10px;">
        Password Updated
      </div>
      <p style="color:var(--muted);font-size:14px;margin-bottom:28px;">
        Your password has been reset successfully. You can now sign in with your new password.
      </p>
      <a href="login.html" class="btn btn-primary" style="text-decoration:none;">
        Go to Login
      </a>
    </div>

  </div>
</div>

<script src="config.js"></script>
<script>
  if (localStorage.getItem('token')) window.location.href = 'play.html';

  // Get token from URL
  const urlParams = new URLSearchParams(window.location.search);
  const resetToken = urlParams.get('token');

  function showStep(id) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // Verify token on page load
  async function verifyToken() {
    if (!resetToken) {
      showStep('stepExpired');
      return;
    }
    try {
      const data = await api.post('/auth/verify-reset-token', { token: resetToken }, false);
      if (data.valid) {
        showStep('stepForm');
      } else {
        showStep('stepExpired');
      }
    } catch (e) {
      showStep('stepExpired');
    }
  }

  function togglePw(id, icon) {
    const input = document.getElementById(id);
    if (input.type === 'password') {
      input.type = 'text'; icon.textContent = 'üôà';
    } else {
      input.type = 'password'; icon.textContent = 'üëÅ';
    }
  }

  function checkStrength(pw) {
    const fill  = document.getElementById('strengthFill');
    const label = document.getElementById('strengthLabel');
    let score   = 0;
    if (pw.length >= 6)  score++;
    if (pw.length >= 10) score++;
    if (/[A-Z]/.test(pw)) score++;
    if (/[0-9]/.test(pw)) score++;
    if (/[^A-Za-z0-9]/.test(pw)) score++;

    const levels = [
      { pct: '0%',   color: '',                label: '' },
      { pct: '25%',  color: '#ef4444',          label: 'Weak' },
      { pct: '50%',  color: '#f97316',          label: 'Fair' },
      { pct: '75%',  color: '#eab308',          label: 'Good' },
      { pct: '90%',  color: '#22c55e',          label: 'Strong' },
      { pct: '100%', color: '#16a34a',          label: 'Very strong' },
    ];
    const lvl    = levels[Math.min(score, 5)];
    fill.style.width      = lvl.pct;
    fill.style.background = lvl.color;
    label.textContent     = lvl.label;
    label.style.color     = lvl.color;
  }

  function showErr(msg) {
    const el = document.getElementById('formErr');
    el.textContent = msg; el.style.display = 'block';
  }
  function hideErr() { document.getElementById('formErr').style.display = 'none'; }

  function setLoading(loading) {
    document.getElementById('resetText').style.display    = loading ? 'none' : 'inline';
    document.getElementById('resetSpinner').style.display = loading ? 'block' : 'none';
    document.getElementById('resetBtn').disabled          = loading;
  }

  async function doReset() {
    hideErr();
    const password = document.getElementById('password').value;
    const confirm  = document.getElementById('confirmPassword').value;

    if (!password)           return showErr('Please enter a new password.');
    if (password.length < 6) return showErr('Password must be at least 6 characters.');
    if (password !== confirm) return showErr('Passwords do not match.');

    setLoading(true);
    try {
      await api.post('/auth/reset-password', { token: resetToken, password }, false);
      showStep('stepSuccess');
    } catch (e) {
      showErr(e.error || 'Failed to reset password. Please try again.');
    } finally {
      setLoading(false);
    }
  }

  // Start by verifying the token
  verifyToken();
</script>
</body>
</html>